<script>
      /* Prevent form submit */
      function preventFormSubmit() {
        var forms = document.querySelectorAll('form');
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener('load', preventFormSubmit);
      
      /* ------Get columns----------------------------------- */
      
      /* Retrieve columns and filters*/
      var divColumns = document.getElementById("columnsList")
      var columnsShow = [];
      var filtersShow = [];
      
      function addColumnsAndFilters(rawData) {
        /* Retrieve columns */
        var columns = rawData['columns']
        for (type in columns) {columnsShow = columnsShow.concat(columns[type])}
        
        for (i in columnsShow) {
           divColumns.innerHTML += '<option name=\"'+columnsShow[i]['label']+'\" data-id='+i+'>'+columnsShow[i]['label']+'</option>'
        }
        
        filters = rawData['filters']
        for (type in filters) {filtersShow = filtersShow.concat(filters[type])}; 
      }

      /* Use token to generate Columns and Filters Details */
      var filter_rules = {"default": [],"custom":[]}
      var logic = filter_rules['custom'].length;
      var logicData = ''
      
      function retrieveDetails() {
        
        var url = document.getElementById('url').value;
        var token = document.getElementById('token').value;
        var reportType = document.getElementById('reportType').selectedOptions[0].value;
        
        /* Clear old data if have */
        divColumns.innerHTML = ''
        document.querySelectorAll("select[id='columnsVisible']")[0].innerHTML=''
        columnsShow = [];
        document.querySelectorAll("div[name='filter']").forEach(i => i.remove());
        filtersShow = [];
        filter_rules = {"default": [],"custom":[]}
        
        
        google.script.run.withSuccessHandler(addColumnsAndFilters).getDetails(url, token, reportType);
        
        /* Switch tab */
        document.getElementById('userDetails').classList.remove('active');
        document.getElementById('selectedColumns').classList.add('active');
        document.getElementById('userForm').classList.remove('active');
        document.getElementById('columnsForm').classList.add('active', 'show');
      }
      
      document.getElementById('submitUser').addEventListener("click",retrieveDetails);
      
      /* Search columns */
      var divColumnsVisible = document.getElementById("columnsVisible");
      var divColumnInput = document.getElementById("columnSearch")
      
      divColumnInput.addEventListener("change", function () {
         var input = divColumnInput.value;
         divColumnsVisible.appendChild(divColumns.options.namedItem(input))
      })
    
      divColumnsVisible.addEventListener("change", function () {
         divColumns.appendChild(this.options[this.selectedIndex])
      })
      
      
      /* -------Get filters----------------------------------------- */
      filter_rules = {"default": [],"custom":[]}
                          
      document.getElementById('addFilter').addEventListener('click', function addFilter() {
         var newGroupNumber = document.querySelectorAll("div[name='filter']").length;
         var filterList = '';
         for (i in filtersShow) {
             filterList = filterList.concat('<option name=\"'+filtersShow[i]['label']+'\" data-id='+filtersShow[i]['field']+'>'+filtersShow[i]['label']+'</option>')
         }
         
         document.getElementById('filterGroup').insertAdjacentHTML("beforeend", 
           '<div class="form-group" data-id=\"'+newGroupNumber+'\" name="filter"> \
             <label name="filter-label"><small>Filter '+(newGroupNumber+1)+'</small></label><br> \
             <div> \
               <input class="form-control" list="filtersList'+newGroupNumber+'\" placeholder="Search field" onchange="updateSelectedFilter(this)"> \
               <datalist id="filtersList'+newGroupNumber+'">'+filterList+'</datalist> \
             </div> \
             <div>  \
               <input class="form-control" list="filterOptions'+newGroupNumber+'\" placeholder="Search value"> \
               <datalist id="filterOptions'+newGroupNumber+'\"></datalist> \
             </div> \
           </div>')
         
       })
       
       function updateSelectedFilter(sel) {
           var filterGroup = sel.parentElement.parentElement
           var filterGroupNumber = filterGroup.dataset['id']
           
           var attribute = sel.list.options.namedItem(sel.value).dataset['id']
           var attributeInfo = filtersShow[filtersShow.map(i => i.field).indexOf(attribute)]
           var model = attributeInfo['model']
           var choices = attributeInfo['choices'];
           var type = attributeInfo['type'];
           var operator = '';
           var choicesList = filterGroup.querySelectorAll("datalist[id=filterOptions"+filterGroupNumber+"]")[0]
           var value;
           
           if (type == 'dropdown') {
             choicesList.innerHTML = '';
             for (i in choices) {
               operator = 'is_in'
               var value = []
               choicesList.innerHTML += '<option name=\"'+choices[i]['value']+'\" data-id='+choices[i]['id']+'>'+choices[i]['value']+'</option>'
             }
           }
           else {
             console.log("Not started yet")
           }
           
          var inputChoicesList = choicesList.previousElementSibling;
          inputChoicesList.addEventListener('change', function () {
            var valueSelected = choicesList.options.namedItem(inputChoicesList.value).dataset['id']
            filter_rules['custom'][filterGroupNumber] = {'attribute':attribute,'operator':operator,'value': value.concat(valueSelected), 'model':model}
            var logic = filter_rules['custom'].length
            var logicData = "1"
            if (logic > 1) {for (i = 2; i < logic+1; i++) {logicData = logicData.concat(" AND "+i.toString())}}
            document.getElementById("logicData").value = logicData
          })
       }
      
      /* Reset filters */
      document.getElementById('resetFilters').addEventListener('click', function() {
        document.querySelectorAll("div[name='filter']").forEach(i => i.remove());
        filter_rules = {"default": [],"custom":[]}
        document.getElementById("logicData").value = ''
      })

      /* ------------------------------------------------------------ */
      /* Generate report based on filters */    
      var divOutput = document.getElementById("output")
      
      function addResult(result) {  
          var result = "<small>"+result+"</small>"
          divOutput.style.visibility = "visible"
          divOutput.innerHTML = result
       }
      
      function showResult() {
        window.scrollTo(0,0) /* Auto scroll to top to see notifications */
        divOutput.style.visibility = "visible"
        document.getElementById("output").innerHTML = '<small>Running</small>'
        
        var url = document.getElementById('url').value;
        var token = document.getElementById('token').value;
        var reportType = document.getElementById('reportType').selectedOptions[0].value;
        
        var columnsSelectedIndex = Array.from(divColumnsVisible.options).map(option => Number(option.dataset['id']));
        var columnsSelected = [];
        for (i in columnsSelectedIndex) {columnsSelected = columnsSelected.concat(columnsShow[columnsSelectedIndex[i]])}
        var columnsSelectedClean = columnsSelected.reduce((r, a) => {r[a.parent_model] = [...r[a.parent_model] || [], a]; return r;}, {});
        console.log(JSON.stringify(columnsSelectedClean))
        
        var dateFilter = document.getElementById('dateFilterDefault').selectedOptions[0].value;
        var frdate = document.getElementById('frdate');
        var frdateValue = frdate.value;
        var todate = document.getElementById('todate');
        var todateValue = document.getElementById('todate').value;
        if (reportType == 'leads_with_converted') {var model = 'Lead'}
        else if (reportType == 'deals') {var model = 'Deal'}
        else if (reportType == 'deal_contacts') {var model = 'Deal'}
        filter_rules['default'] = [{"attribute": dateFilter,"operator": "is_in_the_range","model": model, "value": [frdateValue.substring(8,10)+'/'+frdateValue.substring(5,7)+'/'+frdateValue.substring(0,4), todateValue.substring(8,10)+'/'+todateValue.substring(5,7)+'/'+todateValue.substring(0,4)]}]
        logicData = document.getElementById('logicData').value
        var filter_options = {"logic_type":"advanced","simple_logic_operator":"AND", "logic": "("+logicData+")","filter_rules":filter_rules}
        console.log(JSON.stringify(filter_options))
     
        if (url != "" && token != "" && columnsShow.length > 0
        && frdate != "" && frdate.valueAsDate <= new Date() && todate != "" && todate.valueAsDate >= frdate.valueAsDate) {
           google.script.run.withSuccessHandler(addResult).generateReport(url, token, columnsSelectedClean, filter_options,reportType);
        }
        
        else try {
           if(url == "") throw "Missing Company Name";
           if(token == "") throw "Missing Token";
           if(columnsSelected == "") throw "No Selected Columns";
           if(frdate == "") throw "No From Date";
           if(frdate.valueAsDate > new Date()) throw "From Date should be in the past";
           if(todate == "") throw "No To Date";
           if(todate.valueAsDate < frdate.valueAsDate) throw "To Date should be after From Date";
        }
        catch(err) {
           divOutput.style.visibility = "visible"
           document.getElementById("output").innerHTML += "<small>Errors: " + err + "</small>";
        }
      }

       document.getElementById('submitFilters').addEventListener("click",showResult);
 
</script>